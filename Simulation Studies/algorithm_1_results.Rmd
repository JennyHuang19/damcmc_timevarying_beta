---
title: "algorithm_1_results"
author: "Jenny Yijian Huang"
date: "12/22/2021"
output: html_document
---


# First, we simulate an epidemic with change points in R0 at weeks 2,4.
```{r}
change_point_data <- simulate_change_point_SEM(
  S0 = 1e3, I0 = 1e1, t_end = 6,
  theta = list(R0 = c(2.5, 1.5, 3.5), gamma = 1, lambda = 1, shape = 1),
  change_day = c(2,4),
  iota_dist = "exponential",
  gener = FALSE, b = 1/2,
  E0 = 0, type = "SIR" # "SEIR"
)
cp_data <- change_point_data$x
```

# Below, we visualize the I(t) compartment over time (for the trajectory simulated above.)
```{r}
plot(x = change_point_data$t, y = change_point_data$I)
```

# We will use only the partially observed (incidence) data as input to our DA-MCMC.
```{r}
cp_Y <- observed_data(change_point_data, K=10)
```
$T_k
 [1]  27  85 156 143  88  61  48  91  73  53

$I0
[1] 10

$S0
[1] 1000

$ts
 [1] 0.0 0.6 1.2 1.8 2.4 3.0 3.6 4.2 4.8 5.4 6.0

$t_end
[1] 6

# We see that the chain still converges to the same estimate if we initialize beta to start at a poor initial value.
```{r}
theta0 = list(R0 = 1, beta=0.001, lambda = 1, shape = 1, gamma = 1)
```

# In this sample run, we choose the prior inclusion probability to be h_hat = c(0.30,0.90,0.30,0.90,0.30). A priori, we believe that it is more likely for weeks 2, 4 to correspond to change points rather than weeks 1,3,5.
```{r}
sample_run_cp <- run_DAMCMC_complete(
  theta0, cp_Y, N = 10000,
  rho = 0.2, param = "bg", approx = "ldp",
  iota_dist = "exponential", gener = FALSE, b = 1/2,
  thin = 1,
  par_prior = list(
    a_beta = 0.01, b_beta = 0.01,
    a_gamma = 1, b_gamma = 1,
    a_R0 = 2, b_R0 = 2,
    a_lambda = 1, b_lambda = 1
  ), h_hat = c(0.30,0.90,0.30,0.90,0.30) # P(dbeta_i = 1)
  )
```

# Acceptance Rates
```{r}
sample_run_cp$theta_rate_accept # theta = (dbeta, beta).
sample_run_cp$x_rate_accept # latent data.
```
[1] 0.7813
[1] 0.0293

# From the dbeta_lst (list of change point locations) output from the MCMC, we can analyze the frequencies of change points at each position.
```{r}
analyze_dbeta(sample_run_cp$dbeta_lst)
```

Output:
[[1]]
[1]   19 9988   23 9994    5

[[2]]
[1] 0.0019 0.9988 0.0023 0.9994 0.0005


The count of a 1 appearing (to indicate a change point) for each particular location within the dbeta vector is [1]   19 9988   23 9994    5. As a proportion, this is [0.0019 0.9988 0.0023 0.9994 0.0005]. Hence, we can see the MCMC performs well in recovering the true change point locations.


# MCMC Trace Plots:
```{r}
burnin <- 501
mcmc.trace <- create_tp_data(sample_run_cp$beta_lst[burnin:10000])
summary(mcmc.trace)
```
Iterations = 1:9500
Thinning interval = 1 
Number of chains = 1 
Sample size per chain = 9500 

1. Empirical mean and standard deviation for each variable,
   plus standard error of the mean:

       Mean        SD  Naive SE Time-series SE
X1 0.002578 0.0001883 1.932e-06      1.935e-05
X2 0.002578 0.0001877 1.926e-06      1.947e-05
X3 0.001613 0.0001231 1.263e-06      1.333e-05
X4 0.001613 0.0001233 1.265e-06      1.338e-05
X5 0.004680 0.0003127 3.208e-06      2.736e-05
X6 0.004680 0.0003127 3.208e-06      2.736e-05

2. Quantiles for each variable:

       2.5%      25%      50%      75%    97.5%
X1 0.002222 0.002453 0.002573 0.002701 0.002948
X2 0.002222 0.002452 0.002572 0.002700 0.002947
X3 0.001401 0.001529 0.001602 0.001686 0.001883
X4 0.001401 0.001529 0.001602 0.001687 0.001883
X5 0.004080 0.004466 0.004673 0.004886 0.005312
X6 0.004080 0.004466 0.004673 0.004886 0.005312

```{r}
# Each Xi corresponds to a component in the beta vector.
plot(mcmc.trace)
```
The traceplots seem to be mixing well for each component of the beta vector.

From testing at several initial values (R0 = 1 through 5), the chain converges to the same estimate for the beta vector (the true value for beta is c(0.0025, 0.0025, 0.0015, 0.0015, 0.0035, 0.0035).)

# Autocorrelation Plot:
```{r}
autocorr.plot(mcmc.trace)
```
# Effective Sample Size
```{r}
effectiveSize(mcmc.trace)
```

# Next, we will analyze how the algorithm performs on a simulated epidemic with no change points.

# First, we simulate an epidemic without change points  R0 = 2.5
```{r}
smooth_data <- simulate_SEM(S0 = 1e3, I0 = 1e1, t_end = 6,
  theta = list(R0 = 2.5, gamma = 1, lambda = 1, shape = 1),
  iota_dist = "exponential",
  gener = FALSE, b = 1/2)
  

smooth_dataX <- smooth_data$x
```

# Below, we visualize the I(t) compartment over time (for the trajectory simulated above.)
```{r}
plot(x = smooth_data$t, y = smooth_data$I)
```

# We will use only the partially observed (incidence) data as input to our DA-MCMC.
```{r}
sm_Y <- observed_data(smooth_data, K=10)
```
$T_k
 [1]  21  62 156 217 176 111  74  46  16  12

$I0
[1] 10

$S0
[1] 1000

$ts
 [1] 0.0 0.6 1.2 1.8 2.4 3.0 3.6 4.2 4.8 5.4 6.0

$t_end
[1] 6

# We see that the chain still converges to the same estimate if we initialize beta to start at a poor initial value.
```{r}
theta0 = list(R0 = 1, beta=0.001, lambda = 1, shape = 1, gamma = 1)
```

# In this sample run, we choose the prior inclusion probability to be h_hat = c(0.10,0.10,0.10,0.10,0.10). A priori, we believe that it is unlikely to see any change points for this trajectory.
```{r}
sample_run_nocp <- run_DAMCMC_complete(
  theta0, sm_Y, N = 10000,
  rho = 0.2, param = "bg", approx = "ldp",
  iota_dist = "exponential", gener = FALSE, b = 1/2,
  thin = 1,
  par_prior = list(
    a_beta = 0.01, b_beta = 1,
    a_gamma = 1, b_gamma = 1,
    a_R0 = 2, b_R0 = 2,
    a_lambda = 1, b_lambda = 1
  ), h_hat = c(0.10,0.10,0.10,0.10,0.10) # P(dbeta_i = 1)
  ) 
```

# Acceptance Rates
```{r}
sample_run_nocp$theta_rate_accept # theta = (dbeta, beta).
sample_run_nocp$x_rate_accept # latent data.
```
[1] 0.9015
[1] 0.1001

# From the dbeta_lst (list of change point locations) output from the MCMC, we can analyze the frequencies of change points at each position.
```{r}
analyze_dbeta(sample_run_nocp$dbeta_lst)
```

Output:
[[1]]
[1]  0  0  0 11  0

[[2]]
[1] 0.0000 0.0000 0.0000 0.0011 0.0000


# MCMC Trace Plots:
```{r}
burnin <- 501
mcmc.trace <- create_tp_data(sample_run_nocp$beta_lst[burnin:10000])
summary(mcmc.trace)
```
Iterations = 1:9500
Thinning interval = 1 
Number of chains = 1 
Sample size per chain = 9500 

1. Empirical mean and standard deviation for each variable,
   plus standard error of the mean:

       Mean       SD  Naive SE Time-series SE
X1 0.002688 0.000114 1.169e-06      6.973e-06
X2 0.002688 0.000114 1.169e-06      6.973e-06
X3 0.002688 0.000114 1.169e-06      6.973e-06
X4 0.002688 0.000114 1.169e-06      6.973e-06
X5 0.002688 0.000114 1.169e-06      6.973e-06
X6 0.002688 0.000114 1.169e-06      6.973e-06

2. Quantiles for each variable:

       2.5%      25%      50%      75%    97.5%
X1 0.002468 0.002611 0.002687 0.002765 0.002915
X2 0.002468 0.002611 0.002687 0.002765 0.002915
X3 0.002468 0.002611 0.002687 0.002765 0.002915
X4 0.002468 0.002611 0.002687 0.002765 0.002915
X5 0.002468 0.002611 0.002687 0.002765 0.002915
X6 0.002468 0.002611 0.002687 0.002765 0.002915

```{r}
# Each Xi corresponds to a component in the beta vector.
plot(mcmc.trace)
```

The traceplots seem to be mixing well for each component of the beta vector. 
From testing at several initial starting values (R0 = 1 through 5), we see that the chain converges to the same estimate of around 0.00269 (true value is beta = 0.0025).

# Autocorrelation Plots:
```{r}
autocorr.plot(mcmc.trace)
```

# Effective Sample Size
```{r}
effectiveSize(mcmc.trace)
```
 X1       X2       X3       X4       X5       X6 
267.1273 267.1273 267.1273 267.1273 267.1273 267.1273 
