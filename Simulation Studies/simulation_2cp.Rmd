---
title: "Untitled"
author: "Jenny Yijian Huang"
date: "4/26/2022"
output: html_document
---

```{r}
library(sirchangepoint)

change_point_data_fine <- sim_changepoint_sem(
  S0 = 1e3, I0 = 1e1, t_end = 6,
  theta = list(R0 = c(2.5, 1.5, 3.5), gamma = 1, lambda = 1, shape = 1),
  change_day = c(2,4),
  iota_dist = "exponential",
  gener = FALSE, b = 1/2,
  E0 = 0, type = "SIR" # "SEIR"
)
cp_data <- change_point_data_fine$x
change_point_data_fine$MLE
```

# Below, we visualize the I(t) compartment over time.
```{r}
plot(x = change_point_data_fine$t[1:1500], y = change_point_data_fine$I[1:1500], main="Epidemic Trajectory",
   xlab="Time", ylab="I(t)")
```
# We will use only the partially observed (incidence) data as input to our DA-MCMC.
```{r}
cp_thin_Y <- observed_data(change_point_data_fine, K=80)
```

```{r}
# Change input to accommodate h_hat = 80
cp_thin_Y$ts <- cp_thin_Y$ts*(80/6) # one observation per ts.
cp_thin_Y$t_end <- 80
cp_thin_Y
```

```{r}
plot(x = cp_thin_Y$ts, y = c(0, cp_thin_Y$T_k), main="Observed Counts", xlab="Time", ylab="New Infections")
abline(v=c(27,53),lwd=2,col="red")
```

```{r}
theta0 = list(R0 = 1, beta=0.001, lambda = 1, shape = 1, gamma = 1/(79/6))
```

```{r}
sim_MM_long6 <- run_DAMCMC_complete_smallh6(
  theta0, cp_thin_Y, N = 20000,
  rho = 0.2, param = "bg", approx = "ldp",
  iota_dist = "exponential", gener = FALSE, b = 1/2,
  thin = 1, plt = 2500,
  par_prior = list(
    a_beta = 1, b_beta = 1,
    a_gamma = 1, b_gamma = 1,
    a_R0 = 2, b_R0 = 2,
    a_lambda = 1, b_lambda = 1,
    a_pi11 = 1, b_pi11 = 10,
    a_pi01 = 100, b_pi01 = 100
  ), 
  length_delta = 79,
  x_b_ratio = 2,
  gamma=1/(79/6)
  )
```

```{r}
# acceptance rate
sim_MM_long6$theta_rate_accept
sim_MM_long6$x_rate_accept
```

```{r}
print(analyze_dbeta(sim_MM_long6$dbeta_lst))
print(barplot(analyze_dbeta(sim_MM_long6$dbeta_lst)[[2]], names.arg = seq(1:79), main="Change Point Locations", xlab="Change Point Location",  
 ylab="Proportion of MCMC Samples", 
 border="blue"))
```

```{r}
test_old_proposal <- run_DAMCMC_complete_old(
  theta0, cp_thin_Y, N = 20000,
  rho = 0.2, param = "bg", approx = "ldp",
  iota_dist = "exponential", gener = FALSE, b = 1/2,
  thin = 1, plt = 2500,
  par_prior = list(
    a_beta = 1, b_beta = 1,
    a_gamma = 1, b_gamma = 1,
    a_R0 = 2, b_R0 = 2,
    a_lambda = 1, b_lambda = 1
  ), h_hat = rep(0.5,79), # P(dbeta_i = 1)
  x_b_ratio = 2,
  gamma=1/(79/6)
  ) 
```

```{r}
# acceptance rate
test_old_proposal$theta_rate_accept
test_old_proposal$x_rate_accept
```

# The results are very dependent on the simulated trajectory (regardless of true parameter values).it places the chang e point at 70 for some configurations and 71 for others. visualize the top configurations in a way that is clean.
```{r}
print(analyze_dbeta(test_old_proposal$dbeta_lst))
barplot(analyze_dbeta(test_old_proposal$dbeta_lst)[[2]], names.arg = seq(1:79), main="Change Point Locations", xlab="Change Point Location",  
 ylab="Proportion of MCMC Samples", 
 border="blue")
```
Analyze Delta Beta:

```{r}
dex <- changepoint_locations(sim_MM_long6$dbeta_lst, 5000) 
# replace NA with 0.
dex[is.na(dex)] <- 0
dex <- dex %>% 
  rename("change1" = 1, "change2" = 2)
dex %>% 
  count(change1, change2) %>% 
  mutate(freq = n / sum(n)) %>% 
  arrange(desc(n))
```
```{r fig.width=2, fig.height=2}
dex %>% 
  count(change1, change2) %>% 
  mutate(freq = n / sum(n)) %>% 
  arrange(desc(n)) %>% 
  head(3) %>% 
  unite("change_points", change1:change2, sep = ", ", remove=FALSE) %>% 
  ggplot(data = ., aes(x = change_points, y = freq)) +
  geom_bar(stat = "identity") +
  labs(title = "Top Change Point Configurations", subtitle = "HMM Proposal", y = "Proportion of MCMC Samples", x = "Change Point Time Instants") +
  theme_bw()
```
```{r}
dex <- changepoint_locations(test_old_proposal$dbeta_lst, 5000) 
# replace NA with 0.
dex[is.na(dex)] <- 0
dex <- dex %>% 
  rename("change1" = 1, "change2" = 2)
dex %>% 
  count(change1, change2) %>% 
  mutate(freq = n / sum(n)) %>% 
  arrange(desc(n))
```

```{r fig.width=2, fig.height=2}
dex %>% 
  count(change1, change2) %>% 
  mutate(freq = n / sum(n)) %>% 
  arrange(desc(n)) %>% 
  head(3) %>% 
  unite("change_points", change1:change2, sep = ", ", remove=FALSE) %>% 
  ggplot(data = ., aes(x = change_points, y = freq)) +
  geom_bar(stat = "identity") +
  labs(title = "Top Change Point Configurations", subtitle = "PPM Proposal", y = "Proportion of MCMC Samples", x = "Change Point Time Instants") + 
  theme_bw()
```
# Runtime Comparison
```{r}
sim_MM_long6$run_time
test_old_proposal$run_time
```

# Create dataframe
```{r}
sim_beta_list <- create_mcmc_list(test_old_proposal$beta_lst[5000:20000])
length(sim_beta_list)
```

```{r}
# combine all beta lists into a dataframe.
beta_sim_tidy <- do.call(rbind, Map(data.frame, Iteration = list(c(1:15001)), Beta1 = sim_beta_list[1], Beta2 = sim_beta_list[2], Beta3 = sim_beta_list[3], Beta4 = sim_beta_list[4], Beta5 = sim_beta_list[5], Beta6 = sim_beta_list[6]))
beta_sim_tidy <- beta_sim_tidy %>% 
  remove_burnin(1000)
```

```{r}
# Posterior means
means <- beta_sim_tidy %>%
  dplyr::select(- .data$Iteration) %>%
  {tibble::tibble(
    var  = colnames(.),
    mean = colMeans(.),
  )}
# ESS
ESS = coda::effectiveSize(coda::mcmc(beta_sim_tidy))
ESS # ESS is higher when we correctly specify the model (eg allow for change points.)
```

```{r}
# HMM
# ESS / Sec = 
571.4152 / 239.121
# PPM
313.1347 / 213.925
```





# Next Up
- 1 Component change.
- Run time ESS.
- B(t) estimate.
- covid data


