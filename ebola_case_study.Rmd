---
title: "ebola_case_study"
author: "Jenny Yijian Huang"
date: "3/7/2022"
output: html_document
---

```{r}
length(Y_ebola$T_k) # 73 points corresponds to 72 possible change point locations.

h0 <- 0
h1 <- 0.1
h2 <- 0.5
h3 <- 0.9

h1 <- rep(h2, 67)
h3 <- rep(0, 5)
h <- c(h1, h3)

length(h)
h
```

```{r}
ebola_theta0 <- list("R0" = 1, "beta" = 3e-7, "gamma" = 1e-1, "shape"=1, "lambda"=1)
```

```{r}
ebola_beta_6 <- run_DAMCMC_complete_old(
  ebola_theta0, Y_ebola, N = 20000,
  rho = 0.2, param = "bg", approx = "ldp",
  iota_dist = "exponential", gener = FALSE, b = 1/2,
  thin = 1, plt = 2000,
  par_prior = list(
    a_beta = 1, b_beta = 1,
    a_gamma = 1, b_gamma = 1,
    a_R0 = 2, b_R0 = 2,
    a_lambda = 1, b_lambda = 1
  ), h, # P(dbeta_i = 1)
  x_b_ratio = 2,
  gamma = 0.8
) # segmented_SS_new_x
```

```{r}
analyze_dbeta(ebola_beta_6$dbeta_lst)

barplot(analyze_dbeta(ebola_beta_6$dbeta_lst)[[2]], main="Delta Configurations", xlab="Change Point Location",  
 ylab="Count", 
 border="blue")
abline(h=0.9, col="blue", lty="dashed", lwd=4)
```



```{r}
ebola_beta_7 <- run_DAMCMC_complete_old(
  ebola_theta0, Y_ebola, N = 20000,
  rho = 0.2, param = "bg", approx = "ldp",
  iota_dist = "exponential", gener = FALSE, b = 1/2,
  thin = 1, plt = 500,
  par_prior = list(
    a_beta = 12, b_beta = 2,
    a_gamma = 1, b_gamma = 1,
    a_R0 = 2, b_R0 = 2,
    a_lambda = 1, b_lambda = 1
  ), h_two, # P(dbeta_i = 1)
  x_b_ratio = 2,
  gamma = 0.8
)
```
```{r}
analyze_dbeta(ebola_beta_7$dbeta_lst)

barplot(analyze_dbeta(ebola_beta_7$dbeta_lst)[[2]], main="Delta Configurations", xlab="Change Point Location",  
 ylab="Count", 
 border="blue")
abline(h=0.5, col="blue", lty="dashed", lwd=4)
```
# (LATER) explore why we don't get as many change points with the h's in groups.
```{r}
h0 <- 0
h1 <- 0.1
h2 <- 0.5
h3 <- 0.9

h1 <- rep(c(h0,h0,h2), 22)
h3 <- rep(0, 6)
h_two <- c(h1, h3)

length(h_two)
h_two
```



# Read in Ebola Data. Filter for the Gueckedou Prefecture.
```{r}
path_data = "Ebola/Guinea_modified.csv"
```

```{r}
# Ebola Data
d <- readr::read_csv(
  path_data,
  col_types = readr::cols(
    .default            = readr::col_double(),
    Location            = readr::col_character(),
    `Ebola data source` = readr::col_character(),
    `Indicator type`    = readr::col_character(),
    `Case definition`   = readr::col_character()
  )
) %>%
  dplyr::select(-(2:4)) %>%
  dplyr::group_by(.data$Location) %>%
  dplyr::summarize_all(sum) %>%
  tibble::column_to_rownames("Location") %>%
  as.matrix

nam <- dimnames(d) # THE DIMENSION NAMES OF THE DATASET
dimnames(d) <- NULL
d[, 1 : 10]
T_k_ebola <- d[which(nam[[1]] == "GUECKEDOU"), ] # Ebola started in the GUECKEDOU prefecture


K     <- length(T_k_ebola) # number of time periods
t_end <- K
ts    <- seq(0, t_end, by = 1) # observation schedule

# Observed data
S0 <- 291823 # https://en.wikipedia.org/wiki/Prefectures_of_Guinea
Y_ebola <- list(T_k = T_k_ebola, F_k = NULL, I0 = I0, S0 = S0, ts = ts, t_end = t_end)
```

```{r}
# # Observed data (incidence)
print(T_k_ebola)
print(nam[[1]][14])
print(nam[[2]][c(1:3, 71:73)])
barplot(T_k_ebola, xlab = "Week")
```

```{r}
plot(x = Y_ebola$ts, y = c(0, Y_ebola$T_k), main="Ebola Incidence Observed", xlab="Week", ylab="New Infection Counts")
```

# Change Point D-A MCMC

Create the change point vector h (a prior inclusion probability vector)
```{r}
length(Y_ebola$T_k) # 73 points corresponds to 72 possible change point locations.

h0 <- 0
h1 <- 0.1
h2 <- 0.5
h3 <- 0.9

h <- c(rep(c(h2,h0), 32), rep(c(h0), 8))
length(h)
h
```

```{r}
ebola_theta0 <- list("R0" = 0.01, "beta" = 3e-7, "gamma" = 1, "shape"=1, "lambda"=1)
```

```{r}
ebola_beta <- run_DAMCMC_complete_bug(
  ebola_theta0, Y_ebola, N = 10000,
  rho = 0.2, param = "bg", approx = "ldp",
  iota_dist = "exponential", gener = FALSE, b = 1/2,
  thin = 1, plt = 500,
  par_prior = list(
    a_beta = 12, b_beta = 2,
    a_gamma = 1, b_gamma = 1,
    a_R0 = 2, b_R0 = 2,
    a_lambda = 1, b_lambda = 1
  ), h, # P(dbeta_i = 1)
  x_b_ratio = 2,
  gamma=1
) # segmented_SS_new_x
```
# Marginal Distribution of change point locations
```{r}
analyze_dbeta(ebola_beta$dbeta_lst)

barplot(analyze_dbeta(ebola_beta$dbeta_lst)[[2]], main="Delta Configurations", xlab="Change Point Location",  
 ylab="Count", 
 border="blue")
abline(h=0.5, col="blue", lty="dashed", lwd=4) # change points around 15,40,71
```



# Create Dataframe from raw dbeta and beta lists for frequency plot of configurations.
```{r}
config_df <- create_df_dbeta(ebola_cp$dbeta_lst, ebola_cp$beta_lst, burnin, "X73")
```
# Frequencies of the most common configurations
```{r fig.width=5, fig.height=10}
config_df %>% 
  count(delta_beta) %>% 
  mutate(freq = n / sum(n)) %>% 
  arrange(desc(n)) %>% 
  head(10) %>% 
  ggplot(data = ., aes(x = delta_beta, y = freq)) +
  geom_bar(stat = "identity") +
  labs(title = "Frequency of Configurations", y = "Frequency", x = "Configuration")+ 
  theme(text = element_text(size=5), axis.text.x = element_text(angle = 90))
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

