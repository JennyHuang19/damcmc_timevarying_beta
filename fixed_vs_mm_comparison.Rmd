---
title: "Untitled"
author: "Jenny Yijian Huang"
date: "4/3/2022"
output: html_document
---

# First, we simulate an epidemic with change points in R0 at weeks 2,4 using Gillespie's algorithm.
```{r}
change_point_data_fine <- sim_changepoint_sem(
  S0 = 1e3, I0 = 1e1, t_end = 6,
  theta = list(R0 = c(2.5, 1.5, 3.5), gamma = 1, lambda = 1, shape = 1),
  change_day = c(2,4),
  iota_dist = "exponential",
  gener = FALSE, b = 1/2,
  E0 = 0, type = "SIR" # "SEIR"
)
cp_data <- change_point_data_fine$x

change_point_data_fine$MLE
```

# Below, we visualize the I(t) compartment over time.
```{r}
plot(x = change_point_data_fine$t[1:1500], y = change_point_data_fine$I[1:1500], main="Epidemic Trajectory",
   xlab="Time", ylab="I(t)")
```
# We will use only the partially observed (incidence) data as input to our DA-MCMC.
```{r}
cp_thin_Y <- observed_data(change_point_data_fine, K=80)
```

```{r}
# Change input to accommodate h_hat = 80
cp_thin_Y$ts <- cp_thin_Y$ts*(80/6) # one observation per ts.
cp_thin_Y$t_end <- 80
cp_thin_Y
```

```{r}
plot(x = cp_thin_Y$ts, y = c(0, cp_thin_Y$T_k), main="Observed Counts", xlab="Time", ylab="New Infections")
```

# We see that the chain still converges to the same estimate if we initialize beta to start at a poor initial value.
```{r}
theta0 = list(R0 = 1, beta=0.001, lambda = 1, shape = 1, gamma = 1/(79/6))
```

```{r}
test_old_proposal <- run_DAMCMC_complete_old(
  theta0, cp_thin_Y, N = 20000,
  rho = 0.2, param = "bg", approx = "ldp",
  iota_dist = "exponential", gener = FALSE, b = 1/2,
  thin = 1, plt = 2500,
  par_prior = list(
    a_beta = 1, b_beta = 1,
    a_gamma = 1, b_gamma = 1,
    a_R0 = 2, b_R0 = 2,
    a_lambda = 1, b_lambda = 1
  ), h_hat = rep(0.5,79), # P(dbeta_i = 1)
  x_b_ratio = 2,
  gamma=1/(79/6)
  ) 
```

```{r}
# acceptance rate
test_old_proposal$theta_rate_accept
```

# The results are very dependent on the simulated trajectory (regardless of true parameter values).it places the chang e point at 70 for some configurations and 71 for others. visualize the top configurations in a way that is clean.
```{r}
print(analyze_dbeta(test_old_proposal$dbeta_lst))

barplot(analyze_dbeta(test_old_proposal$dbeta_lst)[[2]], main="Change Point Locations", xlab="Change Point Location",  
 ylab="Proportion of MCMC Samples", 
 border="blue")
abline(h=1/2, col="blue", lty="dashed", lwd=4)
```

```{r}
burnin = 1000
library(tidyverse)
sim_old_df <- create_df_dbeta(test_old_proposal$dbeta_lst, test_old_proposal$beta_lst, burnin, "X79")
sim_old_df
```

# Compute the mean betas of the top configurations.
```{r}
sim_t1 <- sim_old_df %>% 
  count(delta_beta) %>% 
  mutate(freq = n / sum(n)) %>% 
  arrange(desc(n)) %>% 
  head(1)
sim_t1
```


```{r}
beta_over_time_old <- sim_old_df %>% 
  filter(delta_beta %in% sim_t1$delta_beta) %>% 
  mutate(X81 = X80) %>%  # add the stopping week
  select(ID, X1.y:X81)

# colnames(beta_over_time_old) <- c("ID", 1:81)
```

# Create a spagetti plot
```{r}
Rt_plot6 <- beta_over_time_old  %>% 
  pivot_longer(cols = -ID,
                 names_to = "time_unit", names_prefix = "V",
                 names_transform = list(Time = as.integer),
                 values_to = "Beta") %>%
    filter(ID %% 200 == 0) %>% 
  mutate(time_unit = as.numeric(time_unit))
```

```{r}
Rt_plot6 %>% 
    ggplot(aes(x = time_unit, y = Beta, group = ID)) +
    geom_step(alpha = 0.1, color = "red") +
    labs(title = "Beta Over Time", subtitle = "True Changes at times 27, 54", y = "Beta", x = "Time Unit") +
  expand_limits(y = 0)
```


```{r}
sim_MM_long <- run_DAMCMC_complete_smallh6(
  theta0, cp_thin_Y, N = 20000,
  rho = 0.2, param = "bg", approx = "ldp",
  iota_dist = "exponential", gener = FALSE, b = 1/2,
  thin = 1, plt = 2500,
  par_prior = list(
    a_beta = 1, b_beta = 1,
    a_gamma = 1, b_gamma = 1,
    a_R0 = 2, b_R0 = 2,
    a_lambda = 1, b_lambda = 1,
    a_pi11 = 0, b_pi11 = 1,
    a_pi01 = 100, b_pi01 = 100
  ), 
  length_delta = 79,
  x_b_ratio = 2,
  gamma=1/(79/6)
  )
```

```{r}
# acceptance rate
sim_MM_long$theta_rate_accept
```

```{r}
print(analyze_dbeta(sim_MM_long$dbeta_lst))

print(barplot(analyze_dbeta(sim_MM_long$dbeta_lst)[[2]], main="Change Point Locations", xlab="Change Point Location",  
 ylab="Proportion of MCMC Samples", 
 border="blue"))
```

```{r}
# Create dataframe for Pi
burnin = 5000
Pi_tidy <- do.call(rbind, Map(data.frame, Iteration = list(c(burnin:20000)), Pi01 = list(sim_MM_long$pi01_lst[burnin:20000]), Pi11 = list(sim_MM_long$pi11_lst[burnin:20000]) ))
Pi_tidy
```

```{r}
# Traceplots, Posterior Histograms for transition probability matrix
draw_tp(Pi_tidy, 'Pi01',10)
draw_histogram(Pi_tidy, 'Pi01')
# draw_acf(Pi_tidy, 'Pi01', 200)

draw_tp(Pi_tidy, 'Pi11',10)
draw_histogram(Pi_tidy, 'Pi11')
# draw_acf(Pi_tidy, 'Pi11', 200)
```

```{r}
burnin = 5000
sim_df <- create_df_dbeta(sim_MM_long$dbeta_lst, sim_MM_long$beta_lst, burnin, "X79")
sim_df
```

# Frequencies of the most common configurations
```{r}
sim_df %>% 
  count(delta_beta) %>% 
  mutate(freq = n / sum(n)) %>% 
  arrange(desc(n)) %>% 
  head(10) %>% 
  ggplot(data = ., aes(x = delta_beta, y = freq)) +
  geom_bar(stat = "identity") +
  labs(title = "Frequency of Change Point Configurations", y = "Proportion", x = "Configuration")+ 
  theme(text = element_text(size=10), axis.text.x = element_text(angle = 90))
```


# Compute the mean betas of the top configurations.

```{r}
sim_t1 <- sim_df %>% 
  count(delta_beta) %>% 
  mutate(freq = n / sum(n)) %>% 
  arrange(desc(n)) %>% 
  head(1)
sim_t1
```


```{r}
beta_over_time6 <- sim_df %>% 
  filter(delta_beta %in% sim_t1$delta_beta) %>% 
  mutate(X81 = X80) %>%  # add the stopping week
  select(ID, X1.y:X81)

colnames(beta_over_time6) <- c("ID", 1:81)
```

# Create a spagetti plot
```{r}
Rt_plot6 <- beta_over_time6  %>% 
  pivot_longer(cols = -ID,
                 names_to = "time_unit", names_prefix = "V",
                 names_transform = list(Time = as.integer),
                 values_to = "Beta") %>%
    filter(ID %% 200 == 0) %>% 
  mutate(time_unit = as.numeric(time_unit))
```

```{r}
Rt_plot6 %>% 
    ggplot(aes(x = time_unit, y = Beta, group = ID)) +
    geom_step(alpha = 0.1, color = "red") +
    labs(title = "Beta Over Time", subtitle = "True Changes at times 27, 54", y = "Beta", x = "Time Unit") +
  expand_limits(y = 0)
```

